<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Funebra Ear1728 – Emotional Spectrum Analyzer</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#05070b" />
<meta name="color-scheme" content="dark" />
<style>
  :root{
    --bg:#05070b;
    --panel:#0b1018;
    --accent:#0ff0b7;
    --accent2:#ff2f6a;
    --text:#e8f4ff;
    --muted:#7a8699;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    padding:20px;
    background:radial-gradient(circle at top,#11182a 0,#05070b 55%,#000 100%);
    color:var(--text);
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:18px;
  }
  h1{
    margin:0;
    font-size:1.7rem;
    letter-spacing:0.08em;
    text-transform:uppercase;
    text-align:center;
  }
  .subtitle{
    font-size:0.9rem;
    color:var(--muted);
    text-align:center;
    max-width:640px;
  }
  .wrap{
    max-width:1200px;
    width:100%;
    display:flex;
    flex-direction:column;
    gap:18px;
  }
  .panel{
    background:rgba(5,8,15,0.92);
    border-radius:18px;
    border:1px solid rgba(255,255,255,0.04);
    box-shadow:0 18px 35px rgba(0,0,0,0.65);
    padding:16px 18px 18px;
    backdrop-filter:blur(14px);
  }
  .panel h2{
    margin:0 0 10px;
    font-size:1.1rem;
    text-transform:uppercase;
    letter-spacing:0.08em;
    color:var(--accent);
  }
  .controls{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    font-size:0.9rem;
  }
  .controls label{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 9px;
    border-radius:999px;
    background:rgba(255,255,255,0.02);
    border:1px solid rgba(255,255,255,0.08);
  }
  input[type="file"]{
    font-size:0.75rem;
    max-width:210px;
  }
  button{
    border:none;
    border-radius:999px;
    padding:6px 14px;
    font-size:0.85rem;
    font-weight:600;
    text-transform:uppercase;
    letter-spacing:0.08em;
    cursor:pointer;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    color:#020308;
    display:inline-flex;
    align-items:center;
    gap:6px;
    box-shadow:0 8px 18px rgba(0,0,0,0.6);
  }
  button:disabled{
    opacity:0.35;
    cursor:not-allowed;
    box-shadow:none;
  }
  .status{
    font-size:0.8rem;
    color:var(--muted);
    margin-top:8px;
  }
  .grid-wrap{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .grid{
    position:relative;
    margin:0 auto;
    width:min(960px,100%);
    aspect-ratio:48/36;
    display:grid;
    grid-template-columns:repeat(48,1fr);
    grid-template-rows:repeat(36,1fr);
    background:radial-gradient(circle at center,#050812 0,#020308 60%,#000 100%);
    border-radius:22px;
    overflow:hidden;
    border:1px solid rgba(255,255,255,0.08);
  }
  .cell{
    position:relative;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:transform 60ms linear, background-color 60ms linear, color 60ms linear, opacity 80ms linear;
    opacity:0.1;
  }
  .cell-dot{
    width:55%;
    height:55%;
    border-radius:50%;
    background:#fff;
    transform-origin:center;
    transition:inherit;
  }
  .legend{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    font-size:0.8rem;
  }
  .legend-item{
    display:flex;
    align-items:center;
    gap:6px;
    padding:3px 8px;
    border-radius:999px;
    background:rgba(255,255,255,0.02);
    border:1px solid rgba(255,255,255,0.06);
  }
  .legend-swatch{
    width:14px;
    height:14px;
    border-radius:999px;
    background:#fff;
  }
  .legend-joy   { background:linear-gradient(90deg,#ffe66b,#ffbb00); }
  .legend-peace { background:linear-gradient(90deg,#55f5ff,#3ae28b); }
  .legend-anger { background:linear-gradient(90deg,#ff3b3b,#ff0059); }
  .legend-sad   { background:linear-gradient(90deg,#4460ff,#2020aa); }
  .legend-nost  { background:linear-gradient(90deg,#ffb56b,#cc7a26); }

  .source-toggle{
    display:inline-flex;
    border-radius:999px;
    padding:2px;
    background:rgba(255,255,255,0.05);
    border:1px solid rgba(255,255,255,0.12);
  }
  .source-toggle button{
    background:none;
    border-radius:999px;
    box-shadow:none;
    padding:5px 12px;
    text-transform:none;
    font-size:0.8rem;
    letter-spacing:0.04em;
    color:var(--muted);
  }
  .source-toggle button.active{
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    color:#020308;
  }

  .emometer-summary{
    font-size:0.9rem;
    color:var(--muted);
    margin-bottom:10px;
  }
  .emometer-bars{display:flex;flex-direction:column;gap:6px;font-size:0.8rem;}
  .emo-row{display:grid;grid-template-columns:70px 1fr 40px;align-items:center;gap:6px;}
  .emo-label{text-transform:uppercase;letter-spacing:0.07em;font-size:0.7rem;color:var(--muted);}
  .emo-bar{position:relative;height:10px;border-radius:999px;overflow:hidden;background:rgba(255,255,255,0.05);}
  .emo-fill{position:absolute;left:0;top:0;bottom:0;width:0%;border-radius:999px;transition:width 120ms linear, opacity 120ms linear;opacity:0.9;}
  .emo-val{text-align:right;color:var(--muted);}
  .emo-joy  .emo-fill  { background:linear-gradient(90deg,#ffe66b,#ffbb00); }
  .emo-peace .emo-fill { background:linear-gradient(90deg,#55f5ff,#3ae28b); }
  .emo-anger .emo-fill { background:linear-gradient(90deg,#ff3b3b,#ff0059); }
  .emo-sad .emo-fill   { background:linear-gradient(90deg,#4460ff,#2020aa); }
  .emo-nost .emo-fill  { background:linear-gradient(90deg,#ffb56b,#cc7a26); }

  .compass-wrap{display:flex;flex-wrap:wrap;gap:16px;align-items:center;justify-content:flex-start;}
  #emoCompass{width:210px;height:210px;flex:0 0 auto;}
  .compass-ring{fill:none;stroke:rgba(255,255,255,0.06);stroke-width:0.9;}
  .compass-axis{stroke:rgba(255,255,255,0.12);stroke-width:0.9;}
  .compass-poly{fill:rgba(0,255,190,0.35);stroke:rgba(255,255,255,0.9);stroke-width:1.1;fill-opacity:0.65;}
  .compass-label{font-size:5px;letter-spacing:0.14em;text-transform:uppercase;fill:rgba(232,244,255,0.8);}
  .compass-center{fill:#0ff0b7;stroke:#020308;stroke-width:1;}
  .compass-text{flex:1 1 180px;font-size:0.85rem;color:var(--muted);max-width:420px;}
</style>
</head>
<body>
  <h1>Funebra Ear1728</h1>
  <div class="subtitle">
    36×48 = 1728 emotional bn-points. Music flows in, emotion-geometry flows out.<br>
    Joy · Peace · Anger · Sadness · Nostalgia — mapped as color, rotation, and pulse.
  </div>

  <div class="wrap">
    <div class="panel">
      <h2>Input · Engine</h2>
      <div class="controls">
        <div class="source-toggle" id="sourceToggle">
          <button data-src="audio" class="active">Audio (MP3/WAV)</button>
          <button data-src="midi">MIDI (.mid)</button>
        </div>

        <label><span>Audio:</span><input type="file" id="audioFile" accept="audio/*"></label>
        <label><span>MIDI:</span><input type="file" id="midiFile" accept=".mid,.midi"></label>

        <button id="playBtn" disabled>Play</button>
        <button id="stopBtn" disabled>Stop</button>
      </div>
      <div class="status" id="status">
        Select an <strong>audio</strong> or <strong>MIDI</strong> file to feed Ear1728.
      </div>
    </div>

    <div class="panel">
      <h2>Ear1728 Emotional Matrix · 36 × 48</h2>
      <div class="grid-wrap">
        <div id="grid" class="grid"></div>
        <div class="legend">
          <div class="legend-item legend-joy"><div class="legend-swatch"></div> Joy</div>
          <div class="legend-item legend-peace"><div class="legend-swatch"></div> Peace</div>
          <div class="legend-item legend-anger"><div class="legend-swatch"></div> Anger</div>
          <div class="legend-item legend-sad"><div class="legend-swatch"></div> Sadness</div>
          <div class="legend-item legend-nost"><div class="legend-swatch"></div> Nostalgia</div>
        </div>
      </div>
    </div>

    <div class="panel">
      <h2>Emometer · Current Emotional Mix</h2>
      <div id="emometerSummary" class="emometer-summary">Waiting for input…</div>
      <div class="emometer-bars">
        <div class="emo-row"><span class="emo-label">Joy</span><div class="emo-bar emo-joy"><div class="emo-fill" id="emoJoy"></div></div><span class="emo-val" id="emoJoyVal">0%</span></div>
        <div class="emo-row"><span class="emo-label">Peace</span><div class="emo-bar emo-peace"><div class="emo-fill" id="emoPeace"></div></div><span class="emo-val" id="emoPeaceVal">0%</span></div>
        <div class="emo-row"><span class="emo-label">Anger</span><div class="emo-bar emo-anger"><div class="emo-fill" id="emoAnger"></div></div><span class="emo-val" id="emoAngerVal">0%</span></div>
        <div class="emo-row"><span class="emo-label">Sad</span><div class="emo-bar emo-sad"><div class="emo-fill" id="emoSad"></div></div><span class="emo-val" id="emoSadVal">0%</span></div>
        <div class="emo-row"><span class="emo-label">Nost</span><div class="emo-bar emo-nost"><div class="emo-fill" id="emoNost"></div></div><span class="emo-val" id="emoNostVal">0%</span></div>
      </div>
    </div>

    <div class="panel">
      <h2>Emometer v2 · Soul Compass</h2>
      <div class="compass-wrap">
        <svg id="emoCompass" viewBox="-60 -60 120 120">
          <circle cx="0" cy="0" r="52" class="compass-ring"></circle>
          <circle cx="0" cy="0" r="35" class="compass-ring"></circle>
          <circle cx="0" cy="0" r="18" class="compass-ring"></circle>
          <line x1="0" y1="0" x2="0"   y2="-52" class="compass-axis"></line>
          <line x1="0" y1="0" x2="49"  y2="-16" class="compass-axis"></line>
          <line x1="0" y1="0" x2="30"  y2="42"  class="compass-axis"></line>
          <line x1="0" y1="0" x2="-30" y2="42"  class="compass-axis"></line>
          <line x1="0" y1="0" x2="-49" y2="-16" class="compass-axis"></line>
          <polygon id="emoPolygon" class="compass-poly" points="0,-5 5,-2 3,3 -3,3 -5,-2"></polygon>
          <text x="0"   y="-56" text-anchor="middle" class="compass-label">JOY</text>
          <text x="54"  y="-16" text-anchor="start"  class="compass-label">PEACE</text>
          <text x="33"  y="48"  text-anchor="middle" class="compass-label">ANGER</text>
          <text x="-33" y="48"  text-anchor="middle" class="compass-label">SAD</text>
          <text x="-54" y="-16" text-anchor="end"    class="compass-label">NOST</text>
          <circle cx="0" cy="0" r="3" class="compass-center"></circle>
        </svg>
        <div id="emoCompassText" class="compass-text">Waiting for music to draw the soul-vector…</div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/@tonejs/midi@2.0.27/build/Midi.js"></script>

  <script>
  const ROWS=36, COLS=48, TOTAL=ROWS*COLS;

  const gridEl=document.getElementById("grid");
  const statusEl=document.getElementById("status");
  const playBtn=document.getElementById("playBtn");
  const stopBtn=document.getElementById("stopBtn");
  const audioFileInput=document.getElementById("audioFile");
  const midiFileInput=document.getElementById("midiFile");
  const sourceToggle=document.getElementById("sourceToggle");

  const emometerSummary=document.getElementById("emometerSummary");
  const emoBars={joy:emoJoy,peace:emoPeace,anger:emoAnger,sad:emoSad,nost:emoNost};
  const emoVals={joy:emoJoyVal,peace:emoPeaceVal,anger:emoAngerVal,sad:emoSadVal,nost:emoNostVal};

  const emoPolygon=document.getElementById("emoPolygon");
  const emoCompassText=document.getElementById("emoCompassText");

  let sourceMode="audio";
  let columnHistory=[];
  const maxColumns=COLS;
  const cells=[];

  let audioCtx=null, analyser=null, audioSourceNode=null, animationId=null;
  let loadedAudioBuffer=null;

  let midiFrames=[], midiFrameIndex=0, midiPlaying=false, lastMidiTime=0;

  // build bn-cells
  (function initGrid(){
    for(let o=0;o<TOTAL;o++){
      const cell=document.createElement("div");
      cell.className="cell";
      cell.id="bn"+o;
      const dot=document.createElement("div");
      dot.className="cell-dot";
      cell.appendChild(dot);
      gridEl.appendChild(cell);
      cells.push({cell,dot});
    }
  })();

  // toggle mode
  sourceToggle.addEventListener("click", e=>{
    const btn=e.target.closest("button");
    if(!btn) return;
    sourceMode=btn.dataset.src || "audio";
    [...sourceToggle.querySelectorAll("button")].forEach(b=>b.classList.toggle("active", b===btn));
    statusEl.innerHTML = sourceMode==="audio"
      ? "Audio mode: select MP3/WAV then press <b>Play</b>."
      : "MIDI mode: select .mid then press <b>Play</b>.";
    refreshPlayButtonState();
  });

  // load audio
  audioFileInput.addEventListener("change", async (e)=>{
    const file=e.target.files[0];
    if(!file){ loadedAudioBuffer=null; refreshPlayButtonState(); return; }
    try{
      statusEl.textContent="Decoding audio…";
      if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      const buf=await file.arrayBuffer();
      loadedAudioBuffer=await audioCtx.decodeAudioData(buf);
      statusEl.textContent=`Audio loaded: ${file.name}. Ready.`;
      refreshPlayButtonState();
    }catch(err){
      console.error(err);
      statusEl.textContent="Could not decode audio.";
      loadedAudioBuffer=null;
      refreshPlayButtonState();
    }
  });

  function startAudioPlayback(){
    if(!audioCtx||!loadedAudioBuffer) return;
    stopAudioPlayback();
    analyser=audioCtx.createAnalyser();
    analyser.fftSize=2048;
    const dataArray=new Uint8Array(analyser.frequencyBinCount);

    audioSourceNode=audioCtx.createBufferSource();
    audioSourceNode.buffer=loadedAudioBuffer;
    audioSourceNode.connect(analyser);
    analyser.connect(audioCtx.destination);
    audioSourceNode.start();

    const startTime=audioCtx.currentTime;

    function frame(){
      animationId=requestAnimationFrame(frame);
      analyser.getByteFrequencyData(dataArray);
      const elapsed=audioCtx.currentTime-startTime;
      const emotion=analyzeSpectrumToEmotion(dataArray);
      pushEmotionColumn(emotion);
      renderGrid();
      if(elapsed>=loadedAudioBuffer.duration) stopAudioPlayback();
    }
    frame();
  }

  function stopAudioPlayback(){
    if(animationId){ cancelAnimationFrame(animationId); animationId=null; }
    if(audioSourceNode){
      try{ audioSourceNode.stop(); }catch(e){}
      audioSourceNode.disconnect();
      audioSourceNode=null;
    }
  }

  // load MIDI
  midiFileInput.addEventListener("change", async (e)=>{
    const file=e.target.files[0];
    if(!file){ midiFrames=[]; refreshPlayButtonState(); return; }
    try{
      statusEl.textContent="Parsing MIDI…";
      const buf=await file.arrayBuffer();
      const midi=new Midi(buf);
      const step=0.1;
      const steps=Math.floor(midi.duration/step)+1;
      midiFrames=[];
      for(let i=0;i<steps;i++){
        const t0=i*step, t1=t0+step;
        let lows=0,mids=0,highs=0,count=0,velSum=0;
        midi.tracks.forEach(tr=>{
          tr.notes.forEach(n=>{
            if(n.time<t1 && (n.time+n.duration)>t0){
              const p=n.midi, v=n.velocity||0.8;
              if(p<48) lows+=v; else if(p<72) mids+=v; else highs+=v;
              velSum+=v; count++;
            }
          });
        });
        midiFrames.push(midiEmotionsFromBands(lows,mids,highs,velSum,count));
      }
      statusEl.textContent=`MIDI loaded: ${file.name}. Frames: ${midiFrames.length}. Ready.`;
      refreshPlayButtonState();
    }catch(err){
      console.error(err);
      statusEl.textContent="Could not parse MIDI.";
      midiFrames=[];
      refreshPlayButtonState();
    }
  });

  function startMidiPlayback(){
    if(!midiFrames.length) return;
    midiPlaying=true;
    midiFrameIndex=0;
    lastMidiTime=performance.now();
    function tick(now){
      if(!midiPlaying) return;
      if((now-lastMidiTime)/1000>=0.1){
        lastMidiTime=now;
        pushEmotionColumn(midiFrames[midiFrameIndex]);
        renderGrid();
        midiFrameIndex++;
        if(midiFrameIndex>=midiFrames.length){
          midiPlaying=false;
          statusEl.textContent="MIDI playback finished (visual).";
          playBtn.disabled=false; stopBtn.disabled=true;
          return;
        }
      }
      requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  function stopMidiPlayback(){ midiPlaying=false; }

  // emotion model
  function clamp(v,min=0,max=1){ return v<min?min:(v>max?max:v); }

  function analyzeSpectrumToEmotion(freqData){
    const len=freqData.length;
    const bandLowMax=Math.floor(len*0.15);
    const bandMidMax=Math.floor(len*0.45);
    let lowE=0,midE=0,highE=0, lc=0,mc=0,hc=0;
    for(let i=0;i<len;i++){
      const v=freqData[i];
      if(i<bandLowMax){ lowE+=v; lc++; }
      else if(i<bandMidMax){ midE+=v; mc++; }
      else { highE+=v; hc++; }
    }
    const low=lc?lowE/(lc*255):0;
    const mid=mc?midE/(mc*255):0;
    const high=hc?highE/(hc*255):0;

    const total=low+mid+high+1e-6;
    const lowN=low/total, midN=mid/total, highN=high/total;

    let joy=clamp(midN*1.2 - lowN*0.1 - highN*0.2);
    let peace=clamp(lowN*1.1 - highN*0.2);
    let anger=clamp(highN*1.4 + high*0.4 - lowN*0.3);
    let sad=clamp(lowN*0.9 - midN*0.2 + (1-total)*0.4);
    let nost=clamp((midN*0.6 + lowN*0.5) * (0.5 + 0.5*Math.abs(midN-lowN)));

    const sum=joy+peace+anger+sad+nost+1e-6;
    return {joy:joy/sum,peace:peace/sum,anger:anger/sum,sad:sad/sum,nost:nost/sum};
  }

  function midiEmotionsFromBands(lows,mids,highs){
    const total=lows+mids+highs+1e-6;
    const lowN=lows/total, midN=mids/total, highN=highs/total;
    let joy=clamp(midN*1.3);
    let peace=clamp(lowN*1.1 - highN*0.1);
    let anger=clamp(highN*1.4);
    let sad=clamp(lowN*0.8*(1-joy));
    let nost=clamp((midN*0.7+lowN*0.5)*0.7);
    const sum=joy+peace+anger+sad+nost+1e-6;
    return {joy:joy/sum,peace:peace/sum,anger:anger/sum,sad:sad/sum,nost:nost/sum};
  }

  function pushEmotionColumn({joy,peace,anger,sad,nost}){
    const col=new Array(ROWS);
    for(let r=0;r<ROWS;r++){
      let base = r<8?joy : r<16?peace : r<24?anger : r<32?sad : nost;
      const local=(r%8)/7;
      col[r]=clamp(base*(0.6+0.6*(1-Math.abs(local-0.5)*1.6)));
    }
    columnHistory.push({col, emotions:{joy,peace,anger,sad,nost}});
    if(columnHistory.length>maxColumns) columnHistory.shift();
    updateEmometer({joy,peace,anger,sad,nost});
  }

  function renderGrid(){
    const colsCount=columnHistory.length;
    for(let c=0;c<COLS;c++){
      const historyIndex=colsCount-1-(COLS-1-c);
      const column=historyIndex>=0 ? columnHistory[historyIndex] : null;
      for(let r=0;r<ROWS;r++){
        const i=r*COLS+c;
        const {cell,dot}=cells[i];
        if(!column){
          cell.style.opacity=0.05;
          dot.style.transform="scale(0.3)";
          dot.style.backgroundColor="rgba(255,255,255,0.05)";
          continue;
        }
        const intensity=column.col[r];
        const emo=column.emotions;
        const group = r<8?"joy":r<16?"peace":r<24?"anger":r<32?"sad":"nost";
        let hue = group==="joy" ? (50+emo.joy*25)
                : group==="peace" ? (150+emo.peace*40)
                : group==="anger" ? (5+emo.anger*20)
                : group==="sad" ? (220+emo.sad*20)
                : (30+emo.nost*25);
        const sat=60+intensity*25;
        const light=25+intensity*40;
        const scale=0.4+intensity*0.9;
        const spin=(emo.anger-emo.peace)*1.8 + (emo.nost-emo.joy)*0.6;

        dot.style.backgroundColor=`hsl(${hue}, ${sat}%, ${light}%)`;
        dot.style.transform=`scale(${scale}) rotate(${spin}rad)`;
        cell.style.opacity=0.15+intensity*0.9;
      }
    }
  }

  function updateEmometer(emo){
    const keys=["joy","peace","anger","sad","nost"];
    keys.forEach(k=>{
      const v=emo[k]||0;
      const pct=Math.round(v*100);
      emoBars[k].style.width=pct+"%";
      emoBars[k].style.opacity=v>0.02?0.95:0.15;
      emoVals[k].textContent=pct+"%";
    });

    let top="joy", tv=-1;
    keys.forEach(k=>{ if(emo[k]>tv){tv=emo[k]; top=k;} });
    const label = top==="joy"?"Joy":top==="peace"?"Peace":top==="anger"?"Anger":top==="sad"?"Sadness":"Nostalgia";
    emometerSummary.textContent = `Dominant: ${label} (${Math.round(tv*100)}%)`;

    // Soul Compass polygon
    const R=50;
    const ang={joy:-90,peace:-20,anger:55,sad:125,nost:-160};
    const order=["joy","peace","anger","sad","nost"];
    const pts=order.map(k=>{
      const v=0.12+0.88*(emo[k]||0);
      const a=ang[k]*Math.PI/180;
      return `${(Math.cos(a)*R*v).toFixed(2)},${(Math.sin(a)*R*v).toFixed(2)}`;
    }).join(" ");
    emoPolygon.setAttribute("points", pts);

    const hue=(emo.joy||0)*55 + (emo.peace||0)*160 + (emo.anger||0)*5;
    const sat=60+30*((emo.joy||0)+(emo.peace||0)+(emo.anger||0));
    const light=40+10*((emo.peace||0)-(emo.anger||0));
    emoPolygon.style.fill=`hsl(${hue||160}, ${sat}%, ${light}%)`;

    emoCompassText.textContent =
      `Soul-vector leans toward ${label} (${Math.round(tv*100)}%).`;
  }

  // play/stop
  playBtn.addEventListener("click", async ()=>{
    if(sourceMode==="audio"){
      if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      await audioCtx.resume();
      statusEl.innerHTML="Listening to audio… projecting emotion geometry.";
      playBtn.disabled=true; stopBtn.disabled=false;
      startAudioPlayback();
    }else{
      if(!midiFrames.length){ statusEl.textContent="Load a MIDI file first."; return; }
      statusEl.innerHTML="Reading MIDI… stepping through emotional frames.";
      playBtn.disabled=true; stopBtn.disabled=false;
      startMidiPlayback();
    }
  });

  stopBtn.addEventListener("click", ()=>{
    if(sourceMode==="audio") stopAudioPlayback(); else stopMidiPlayback();
    statusEl.textContent="Stopped.";
    playBtn.disabled=false; stopBtn.disabled=true;
  });

  function refreshPlayButtonState(){
    playBtn.disabled = sourceMode==="audio" ? !loadedAudioBuffer : !midiFrames.length;
    stopBtn.disabled = true;
  }
  refreshPlayButtonState();
  </script>
</body>
</html>
